name: Deploy FilterFacts (Backend + PostgreSQL pgvector) to Naver Cloud Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source
        uses: actions/checkout@v4

      # âœ… 2ï¸âƒ£ JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # âœ… 3ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # âœ… 4ï¸âƒ£ NCP Container Registry ë¡œê·¸ì¸
      - name: Login to NCP Container Registry
        run: |
          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin contest-cluster54-registry.kr.ncr.ntruss.com

      # âœ… 5ï¸âƒ£ Backend ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: Build and Push Backend Docker image
        id: backend
        run: |
          IMAGE=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-backend
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "BACKEND_TAG=$TAG" >> $GITHUB_ENV
          echo "ğŸš€ Building Backend image with tag: $TAG"
          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest
          echo "âœ… Backend image push complete!"

      # âœ… 6ï¸âƒ£ PostgreSQL + pgvector ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: Build and Push PostgreSQL pgvector image
        id: pgvector
        run: |
          PG_IMAGE=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-postgres
          echo "ğŸ˜ Building PostgreSQL pgvector image..."
          docker build -t $PG_IMAGE:latest -f ./Dockerfile.pgvector .
          docker push $PG_IMAGE:latest
          echo "âœ… PostgreSQL pgvector image push complete!"

      # âœ… 7ï¸âƒ£ NCP IAM Authenticator ì„¤ì¹˜
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          else
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          fi
          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/

      # âœ… 8ï¸âƒ£ NCP ì„¤ì • ë³µì›
      - name: Restore Naver Cloud config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure

      # âœ… 9ï¸âƒ£ Kubeconfig ë³µì›
      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # âœ… ğŸ”Ÿ PostgreSQL Deployment ë°˜ì˜
      - name: Apply PostgreSQL Deployment
        run: |
          echo "ğŸ“¦ Applying PostgreSQL Deployment (postgres-deploy.yaml)..."
          kubectl apply -f postgres-deploy.yaml
          kubectl rollout status deployment/postgres --timeout=200s || true

      # âœ… 1ï¸âƒ£1ï¸âƒ£ Backend Deployment ë°˜ì˜
      - name: Apply Backend Deployment
        run: |
          echo "ğŸ“¦ Applying Backend Deployment (deploy.yaml)..."
          kubectl apply -f deploy.yaml

      # âœ… 1ï¸âƒ£2ï¸âƒ£ Backend ìƒˆ TAG ë°˜ì˜ (ë¡¤ë§ ì—…ë°ì´íŠ¸)
      - name: Deploy Backend with Updated Image Tag
        run: |
          echo "â˜• Deploying backend with new image tag: ${{ env.BACKEND_TAG }}"
          kubectl set image deployment/f-f-backend \
            f-f-backend=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-backend:${{ env.BACKEND_TAG }} \
            --record
          kubectl rollout status deployment/f-f-backend --timeout=200s

      # âœ… 1ï¸âƒ£3ï¸âƒ£ ë°°í¬ ìƒíƒœ ê²€ì¦
      - name: âœ… Verify Deployment Status
        run: |
          kubectl get pods -o wide
          kubectl get svc
