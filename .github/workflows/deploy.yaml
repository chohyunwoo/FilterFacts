LoadBalancerëŠ” ì™¸ë¶€ ì ‘ê·¼ì ì„ ì—¬ëŸ¬ê°œ ë§Œë“œëŠ” ë¦¬ì†ŒìŠ¤
ë¶€í•˜ ë¶„ì‚°(LoadBalancer) ìì²´ëŠ” Deployment +Service ê°€ ë‹´ë‹¹

ì‹¤ì œ íŠ¸ë˜í”½ ë¶„ì‚°ì€ replica  ìˆ˜ê°€ í•µì‹¬ì´ë‹¤

Deployment.yaml   <-  ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜(pod)ë¥¼ ê´€ë¦¬í•˜ëŠ” ìë™í™”ëœ ìš´ì˜ ê´€ë¦¬ì 
ì‰½ê²Œ ë§í•˜ë©´ Podë¥¼ ì§ì ‘ ë„ìš°ê±°ë‚˜ ì§€ìš°ì§€ ì•Šì•„ë„, ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ëŒ€ì‹  ì§€ì†ì ìœ¼ë¡œ ê´€ë¦¬í•´ì£¼ëŠ” ë¡œë´‡ ê´€ë¦¬ì

| ê¸°ëŠ¥                            | ì„¤ëª…                                           |
| ----------------------------- | -------------------------------------------- |
| âœ… **Pod ìë™ ìƒì„±/ìœ ì§€**            | ì§€ì •í•œ ê°œìˆ˜(`replicas`)ë§Œí¼ Podì„ ìë™ ìƒì„±í•˜ê³  í•­ìƒ ê·¸ ìˆ˜ë¥¼ ìœ ì§€ |
| âœ… **ìë™ ì¬ì‹œì‘ / ë³µêµ¬**             | Podì´ ì£½ê±°ë‚˜ ì¥ì•  ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ ìƒˆ Podì„ ìƒì„±              |
| âœ… **Rolling Update (ë¬´ì¤‘ë‹¨ ë°°í¬)** | ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´í•  ë•Œ ê¸°ì¡´ Podì„ ëŠì§€ ì•Šê³  ìˆœì°¨ êµì²´             |
| âœ… **Rollback (ë²„ì „ ë³µêµ¬)**        | ë¬¸ì œê°€ ìƒê¸°ë©´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë°”ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŒ                  |
| âœ… **Replica ê´€ë¦¬ (ìŠ¤ì¼€ì¼ë§)**       | Pod ê°œìˆ˜ë¥¼ ëŠ˜ë¦¬ê±°ë‚˜ ì¤„ì´ëŠ” Scale-out / Scale-in ì§€ì›     |


Deployment.yaml <- ì´ì¹œêµ¬ ë•ë¶„ì— 
ìƒˆ Pod(V2)ë¥¼ í•˜ë‚˜ë„ìš°ê³ 
ì¤€ë¹„ë˜ë©´ ê¸°ì¡´ì˜  Pod(V1) í•˜ë‚˜ ì œê±°
ë‹¤ì‹œ ìƒˆ Pod(V2) ë„ìš´ë‹¤
ê¸°ì¡´ Pod ì „ë¶€ êµì²´ ë  ë•Œê¹Œì§€ ë°˜ë³µí•œë‹¤
** ì´ë¡œì¨ ë¬´ì¤‘ë‹¨ ë°°í¬ê°€ ê°€ëŠ¥í•˜ë‹¤ 

Deployment <-  ìë™ì ìœ¼ë¡œ RollingUpdateë¥¼ í•œë‹¤
RollingUpdateê°€ ë¬´ì—‡ì¸ê°€?
ë¬´ì¤‘ë‹¨ ë°°í¬ê°€ ê°€ëŠ¥í•˜ë‹¤ê³  í•œ ì§€ì ë¶€í„° ì½ì–´ë³´ë©´ ëœë‹¤.

ollamaë¥¼ ì™œ ë¡œë“œë°¸ëŸ°ì„œë¡œ ë°°í¬í–ˆëŠ”ê°€?
AI  ì„œë²„ê°€ ë‚´ë¶€ì—ì„œ ì ‘ê·¼í•˜ì§€ë§Œ, ì™¸ë¶€ì—ì„œë„ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•¨ (ì™¸ë¶€ ì ê²€/ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)





name: Deploy FilterFacts to Naver Cloud Kubernetes (Token-based)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source
        uses: actions/checkout@v4

      # âœ… 2. JDK ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # âœ… 3. Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # âœ… 5. Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: Build and Push Backend Docker image
        id: build
        run: |
          IMAGE=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-backend
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "ğŸš€ Building Backend image with tag: $TAG"

          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin contest-cluster54-registry.kr.ncr.ntruss.com

          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest

          echo "âœ… Backend push complete!"

      # âœ… 6. IAM Authenticator ì„¤ì¹˜
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          else
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          fi

          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/

      # âœ… 7. ì„¤ì • ê°€ì ¸ì˜¤ê¸°
      - name: Restore Naver Cloud config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure

      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # âœ… 8. ë°°í¬ íŒŒì¼ ë°˜ì˜ (Pod replica, ENV ë³€ê²½ ì ìš©)
      - name: Apply Deployment YAML
        run: |
          kubectl apply -f deploy.yaml

      # âœ… 9. Backend ìƒˆë¡œìš´ TAG ì ìš© (ë¡¤ë§ ì—…ë°ì´íŠ¸)
      - name: Deploy Backend with Updated Image Tag
        run: |
          echo "â˜• Deploying backend with tag: $TAG"
          kubectl set image deployment/f-f-backend \
            f-f-backend=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-backend:$TAG \
            --record
          kubectl rollout status deployment/f-f-backend --timeout=200s

      # âœ… 10. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: âœ… Verify Deployment Status
        run: |
          kubectl get pods -o wide
          kubectl get svc
