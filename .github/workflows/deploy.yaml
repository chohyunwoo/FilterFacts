name: Deploy FilterFacts to Naver Cloud Kubernetes (Token-based)

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

       # 4ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker image
        run: |
          IMAGE=contest-cluster54-registry.kr.ncr.ntruss.com/filterfacts-backend:latest
          
          echo "ğŸ”‘ Logging in to Naver Cloud Registry..."
          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin contest-cluster54-registry.kr.ncr.ntruss.com

          echo "ğŸš€ Building Docker image (forcing new JAR)..."
          docker build --no-cache \
            --build-arg CACHEBUST=$(date +%s) \
            -t $IMAGE .

          echo "ğŸ“¦ Pushing image to Naver Cloud Registry..."
          docker push $IMAGE

      # 5ï¸âƒ£ ìµœì‹  IAM Authenticator ì„¤ì¹˜ (v1.1.1)
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          elif [ "$ARCH" = "aarch64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          else
            echo "âŒ Unsupported architecture: $ARCH"
            exit 1
          fi

          echo "ğŸ“¦ Downloading NCP IAM Authenticator (v1.1.1)..."
          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/
          echo "âœ… Installed version:"
          ncp-iam-authenticator version

      # 6ï¸âƒ£ Naver Cloud configure ë³µì› (AccessKey + SecretKey)
      - name: Restore Naver Cloud config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure
          echo "âœ… ~/.ncloud/configure restored successfully!"

      # 7ï¸âƒ£ kubeconfig ë³µì›
      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "âœ… kubeconfig restored successfully"
          kubectl config get-contexts

      # 8ï¸âƒ£ IAM Authenticator í† í° í™•ì¸
      - name: Verify IAM Authenticator
        run: |
          echo "ğŸ”‘ Verifying IAM Authenticator..."
          ncp-iam-authenticator token --clusterUuid 8ecb23d9-10ef-4041-80ed-6f65f2e0f0c3 --region KR || echo "âš ï¸ Token test failed, check AccessKey configuration."

      # 9ï¸âƒ£ PostgreSQL ë¨¼ì € ë°°í¬
      - name: ğŸ—„ï¸ Deploy PostgreSQL to NKS
        run: |
          echo "ğŸ—„ï¸ Deploying PostgreSQL..."
          kubectl apply -f postgres-deploy.yaml --validate=false

      # ğŸ”Ÿ Redis ë°°í¬
      - name: ğŸš€ Deploy Redis to NKS
        run: |
          echo "ğŸš€ Deploying Redis..."
          kubectl apply -f redis-deploy.yaml --validate=false

      # 11ï¸âƒ£ Backend(Spring Boot) ë°°í¬ (ë§ˆì§€ë§‰)
      - name: â˜• Deploy FilterFacts Backend to NKS
        run: |
          echo "â˜• Deploying FilterFacts Backend..."
          kubectl apply -f deploy.yaml --validate=false

      # 12ï¸âƒ£ ë°°í¬ í™•ì¸
      - name: âœ… Verify Deployment Status
        run: |
          kubectl get pods
          kubectl get svc
