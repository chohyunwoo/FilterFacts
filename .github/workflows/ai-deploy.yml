name: Deploy AI Server to NKS
on:
  push:
    branches:
      - ai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build and Push AI Server image
        run: |
          IMAGE=contest-cluster54-registry.kr.ncr.ntruss.com/ai-server
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin contest-cluster54-registry.kr.ncr.ntruss.com

          docker build -t $IMAGE:$TAG -t $IMAGE:latest -f ./Dockerfile .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest

      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config

      - name: Deploy AI Server
        run: |
          kubectl set image deployment/ai-server \
            ai-server=contest-cluster54-registry.kr.ncr.ntruss.com/ai-server:$TAG \
            --record
          kubectl rollout status deployment/ai-server --timeout=200s
